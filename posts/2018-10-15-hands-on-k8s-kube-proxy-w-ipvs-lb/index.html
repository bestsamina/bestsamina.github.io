<!DOCTYPE html>
<html lang="en-us">
    <head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.44" />
    
    
    <title>實現 IPVS-based K8s service load balancing - 不同 namespace 擁有自己的 external IP • Samina&#39;s 技術筆記 X 點滴紀錄</title>
<meta name="description" content="Samina&#39;s 技術筆記 X 點滴紀錄 :: 記錄一些技術筆記與生活紀錄">
<meta name="keywords" content="blog,python,golang,javascript,container,opencord,cord,sdn,network">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="實現 IPVS-based K8s service load balancing - 不同 namespace 擁有自己的 external IP"/>
<meta name="twitter:description" content="文章脈絡 - 前置作業 - 環境說明 - K8s 於不同 namespace 擁有自己的 external IP 之環境 - 部署 - 測試
前置作業  把 IPVS 的 kernel module load 進來  modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack_ipv4 cut -f1 -d &quot; &quot; /proc/modules | grep -e ip_vs -e nf_conntrack_ipv4   在啟動 kube-proxy 時，參數設為  --proxy-mode=ipvs  (如果要使用其他演算法，那可以設定 --ipvs-scheduler=rr rr 改為其他的)
 如果是在 v.10 之前的版本， kube-proxy 要加下面的參數  --feature-gates=SupportIPVSProxyMode=true   建立 k8s 環境(安裝 tool: https://github."/>

<meta property="og:title" content="實現 IPVS-based K8s service load balancing - 不同 namespace 擁有自己的 external IP" />
<meta property="og:description" content="文章脈絡 - 前置作業 - 環境說明 - K8s 於不同 namespace 擁有自己的 external IP 之環境 - 部署 - 測試
前置作業  把 IPVS 的 kernel module load 進來  modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack_ipv4 cut -f1 -d &quot; &quot; /proc/modules | grep -e ip_vs -e nf_conntrack_ipv4   在啟動 kube-proxy 時，參數設為  --proxy-mode=ipvs  (如果要使用其他演算法，那可以設定 --ipvs-scheduler=rr rr 改為其他的)
 如果是在 v.10 之前的版本， kube-proxy 要加下面的參數  --feature-gates=SupportIPVSProxyMode=true   建立 k8s 環境(安裝 tool: https://github." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bestsamina.github.io/posts/2018-10-15-hands-on-k8s-kube-proxy-w-ipvs-lb/" />



<meta property="article:published_time" content="2018-10-15T11:25:11&#43;08:00"/>

<meta property="article:modified_time" content="2018-10-15T11:25:11&#43;08:00"/>












    <!-- Font-Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/solid.css" integrity="sha384-TbilV5Lbhlwdyc4RuIV/JhD8NR+BfMrvz4BL5QFa2we1hQu6wvREr3v6XSRfCTRp" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/brands.css" integrity="sha384-7xAnn7Zm3QC1jFjVc1A6v/toepoG3JXboQYzbM0jrPzou9OFXm/fY6Z/XiIebl/k" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/fontawesome.css" integrity="sha384-ozJwkrqb90Oa3ZNb+yKFW2lToAWYdTiF1vt8JiH5ptTGHTGcN7qdoR1F95e0kYyG" crossorigin="anonymous">
    <!-- highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <link rel="stylesheet" href="https://bestsamina.github.io//css/print.min.css" media="print">
    <link rel="stylesheet" href="https://bestsamina.github.io//css/hyde-hyde.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png"></head>

    <body>
        
<div class="sidebar text-center">
  <div class="container ">
    <div class="sidebar-about">
      <div class="site__title">
        <a href="https://bestsamina.github.io/">Samina&#39;s 技術筆記 X 點滴紀錄</a>
      </div>
      
      
      
      <p>
        <img src="https://bestsamina.github.io/images/sufuf3_1519028337_878.jpg" alt="Author Image" class="img--circle img--headshot element--center"> 
      </p>
      
      <p class="site__description">
         記錄一些技術筆記與生活紀錄 
      </p>
    </div>
    <div>
	<ul class="sidebar-nav">
		
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
				<li>
					<a href="/series/">
						<span>Series</span>
					</a>
				</li>
				<li>
					<a href="/tags/">
						<span>Tags</span>
					</a>
				</li>
				<li>
					<a href="/categories/">
						<span>Categories</span>
					</a>
				</li>
				<li>
					<a href="/page/awesome-blogs">
						<span>Awesome-Blogs</span>
					</a>
				</li>
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
		</li>
	</ul>
</div>

    <p>
      <section class="social text-center">
	<a href="https://twitter.com/sufuf3149"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	&nbsp;<a href="https://github.com/sufuf3"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	&nbsp;<a href="https://gitlab.com/sufuf3"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
</section>

    </p>
    <p class="copyright">
      &copy; 2018 Samina Fu.
      <a href="https://creativecommons.org/licenses/by-sa/4.0">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
  <div>
  </div>
</div>
<div class="content container">
            <article>
  <header>
    <h1>實現 IPVS-based K8s service load balancing - 不同 namespace 擁有自己的 external IP</h1>
     
    
<div class="post__meta">
    
    <i class="fas fa-calendar-alt"></i> Oct 15, 2018
    in
              
              
              <a class="post__category" href="/categories/kubernetes">A KUBERNETES</a>
              
              
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="post__tag" href="/tags/kubernetes">#kubernetes</a>
           
      
          <a class="post__tag" href="/tags/k8s">#k8s</a>
           
      
          <a class="post__tag" href="/tags/container">#container</a>
           
      
          <a class="post__tag" href="/tags/kube-proxy">#kube-proxy</a>
           
      
          <a class="post__tag" href="/tags/ipvs">#ipvs</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 2 min read
</div>


  </header>
  <div class="post">
    

<p>文章脈絡
- 前置作業
- 環境說明
- K8s 於不同 namespace 擁有自己的 external IP 之環境
   - 部署
   - 測試</p>

<h2 id="前置作業">前置作業</h2>

<ol>
<li>把 IPVS 的 kernel module load 進來</li>
</ol>

<pre><code>modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
cut -f1 -d &quot; &quot;  /proc/modules | grep -e ip_vs -e nf_conntrack_ipv4
</code></pre>

<ol>
<li>在啟動 kube-proxy 時，參數設為</li>
</ol>

<pre><code>--proxy-mode=ipvs
</code></pre>

<p>(如果要使用其他演算法，那可以設定 <code>--ipvs-scheduler=rr</code> rr 改為其他的)</p>

<ol>
<li>如果是在 v.10 之前的版本， kube-proxy 要加下面的參數</li>
</ol>

<pre><code>--feature-gates=SupportIPVSProxyMode=true
</code></pre>

<ol>
<li>建立 k8s 環境(安裝 tool: <a href="https://github.com/kairen/kube-ansible">https://github.com/kairen/kube-ansible</a>)</li>
</ol>

<h2 id="環境說明">環境說明</h2>

<p>100.67.151.2 master
100.67.151.4 master
100.67.151.5 master
100.67.151.6 worker
100.57.151.8 masters VIP (keepalived)</p>

<h2 id="k8s-於不同-namespace-擁有自己的-external-ip-之環境">K8s 於不同 namespace 擁有自己的 external IP 之環境</h2>

<h3 id="部署">部署</h3>

<ol>
<li>create namespaces
在其中一台 master 主機上執行以下指令<br /></li>
</ol>

<pre><code>cat &lt;&lt;EOF | kubectl create -f -
apiVersion: v1
kind: Namespace
metadata:
  name: user-a-ns
---
apiVersion: v1
kind: Namespace
metadata:
  name: user-b-ns
EOF
</code></pre>

<ol>
<li>Create deployments
在其中一台 master 主機上執行以下指令<br /></li>
</ol>

<pre><code>kubectl run nginx --namespace=user-a-ns --image=nginx --replicas=2

kubectl run nginx --namespace=user-b-ns --image=nginx --replicas=2
</code></pre>

<ol>
<li>Create service
在其中一台 master 主機上執行以下指令<br />
external-ip 後的參數需設定為IP Pool (VIP List)裡的IP<br />
ex. VIP List: 100.67.151.9,100.67.151.10<br /></li>
</ol>

<pre><code>kubectl expose deployment nginx --namespace=user-a-ns --port 80 --external-ip 100.67.151.9
kubectl expose deployment nginx --namespace=user-b-ns --port 80 --external-ip 100.67.151.10
</code></pre>

<ol>
<li>將 VIP List 綁定在網卡上
在其中一台 master 主機上執行以下指令<br />
暫解將eth0掛上VIP List的資訊，<br />
ex. VIP List: 100.67.151.9,100.67.151.10<br /></li>
</ol>

<pre><code>sudo ifconfig eth0:0 100.67.151.9 netmask 255.255.0.0 broadcast 100.67.255.255
sudo ifconfig eth0:1 100.67.151.10 netmask 255.255.0.0 broadcast 100.67.255.255
</code></pre>

<h3 id="測試">測試</h3>

<ol>
<li><p>從外部 access (可 access 100.67.0.0/16 網段的 client)
打開瀏覽器連 <a href="http://100.67.151.9">http://100.67.151.9</a> 與 <a href="http://100.67.151.10">http://100.67.151.10</a></p></li>

<li><p>相關資訊</p></li>
</ol>

<pre><code>$ ip a
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:26:2d:08:03:a4 brd ff:ff:ff:ff:ff:ff
    inet 100.67.151.2/16 brd 100.67.255.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
    inet 100.67.151.9/16 brd 100.67.255.255 scope global secondary eth0:0
       valid_lft forever preferred_lft forever
    inet 100.67.151.10/16 brd 100.67.255.255 scope global secondary eth0:1
       valid_lft forever preferred_lft forever
    inet6 fe80::226:2dff:fe08:3a4/64 scope link 
       valid_lft forever preferred_lft forever

$ ipvsadm -ln
TCP  100.67.151.9:80 rr
  -&gt; 10.244.241.156:80            Masq    1      0          0         
  -&gt; 10.244.241.158:80            Masq    1      0          0         
TCP  100.67.151.10:80 rr
  -&gt; 10.244.241.157:80            Masq    1      0          0         
  -&gt; 10.244.241.159:80            Masq    1      0          0   
</code></pre>

<h2 id="ref">Ref</h2>

<ul>
<li><a href="https://www.hi-linux.com/posts/29792.html">https://www.hi-linux.com/posts/29792.html</a></li>
</ul>

  </div>
  <div>
    <ul class="post__nav">
        <li class="post__nav--next">
            
        </li>
        <li class="post__nav--previous">
            <i class="fas fa-chevron-left"></i>
            <a href="/posts/2018-10-11-github-oauth/">                
                <span class="previous__heading">PREVIOUS</span>
                <span class="previous__title">申請 GitHub OAuth 權限紀錄</span>
            </a>
        </li>
    </ul>
</div>

  <div class="post__related">
    
    
    
    <h2>Related Articles</h2>
    <ul class="related-posts">
        
<li>
  <span class="list__title--small">
    <a href="/2018/03/09/kubernetes-%E5%AD%B8%E7%BF%92%E7%AD%86%E8%A8%98/">[Kubernetes] 學習筆記</a>
      
      <time class="pull-right hidden-tablet">Mar 09 &#39;18</time>
      
  </span>
</li>

    </ul>
    
</div>
</article>
        </div>
        <div class="container content"><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

<script type="text/javascript">
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
</script>
<div id="disqus_thread"></div>
<script type="text/javascript">
      (function () {
            
            
            
            if (location.hostname === "localhost" || 
            	location.hostname === "127.0.0.1" || 
            	location.hostname === "") {
                return;
			}
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            var disqus_shortname = 'bestsamina';
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(
                  dsq);
      })();
</script>

<noscript>
	Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    </div>
    

    </body>
</html>
