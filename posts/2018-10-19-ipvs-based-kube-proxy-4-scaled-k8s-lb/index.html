<!DOCTYPE html>
<html lang='en'><head>
  <title>IPVS-based Kube-proxy for Scaled Kubernetes Load Balancing - Samina Website</title>
  <link rel='canonical' href='https://bestsamina.github.io/posts/2018-10-19-ipvs-based-kube-proxy-4-scaled-k8s-lb/' />
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <meta name='description' content='' />
  <meta name='theme-color' content='#D250F4' />
  
    <link rel="shortcut icon" href="/images/favicon.jpg" type="image/x-icon" />
    <link rel="icon" href="/images/favicon.jpg" type="image/x-icon" />
  

  <meta name="generator" content="Hugo 0.97.3" />

  





<link rel="stylesheet" href="https://bestsamina.github.io/sass/style.min.5a3cd6465e2d17087010765b79f4b67f107ff2a690781fbbfa18ece52420931b.css" integrity="sha256-WjzWRl4tFwhwEHZbefS2fxB/8qaQeB&#43;7&#43;hjs5SQgkxs=" media="screen">
<link rel="stylesheet" href="https://bestsamina.github.io/syntax.min.css" integrity="" media="screen">

  <meta property="og:title" content="IPVS-based Kube-proxy for Scaled Kubernetes Load Balancing" />
<meta property="og:description" content="é€™ç¯‡ç‚º 10æœˆ19æ—¥ talk çš„æ–‡å­—ç‰ˆï¼Œ slides æ˜¯ https://speakerdeck.com/sufuf3/ipvs-based-kube-proxy-for-scaled-kubernetes-load-balancing ã€‚
 å…§å®¹è„ˆçµ¡
 Preface (å‰è¨€) Introduction (ä»‹ç´¹) Kube-Proxy  What is Kube-proxy (ä»€éº¼æ˜¯ Kube-proxy) Kube-Proxy mode   IPVS  LVS What is IPVS (ä»€éº¼æ˜¯ IPVS) IPVS with Netfilter (IPVS å’Œ Netfilter) IPVS vs iptables (IPVS èˆ‡ iptables çš„æ¯”è¼ƒ)   IPVS-based Kube-proxy  Why using IPVS? (ç‚ºä»€éº¼è¦ç”¨ IPVS) How IPVS-based Kube-proxy work? (IPVS-based Kube-proxy æ˜¯æ€éº¼é‹ä½œçš„) Run Kube-proxy in IPVS mode (ä¾†åŸ·è¡Œ IPVS mode çš„ Kube-proxy) IPVS Service Network Topology Example   Implement IPVS-based K8s service load balancing (å¯¦ç¾ IPVS-based K8s service load balancing) Conclusion (çµè«–)  Preface (å‰è¨€) åœ¨ä¸€èˆ¬ä½¿ç”¨ Kubernetes çš„ kube-proxy æƒ…æ³ä¸‹ï¼Œé€šå¸¸éƒ½ä½¿ç”¨ iptables æ¨¡å¼ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bestsamina.github.io/posts/2018-10-19-ipvs-based-kube-proxy-4-scaled-k8s-lb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-10-15T12:05:37+08:00" />
<meta property="article:modified_time" content="2018-10-15T12:05:37+08:00" />


  <meta itemprop="name" content="IPVS-based Kube-proxy for Scaled Kubernetes Load Balancing">
<meta itemprop="description" content="é€™ç¯‡ç‚º 10æœˆ19æ—¥ talk çš„æ–‡å­—ç‰ˆï¼Œ slides æ˜¯ https://speakerdeck.com/sufuf3/ipvs-based-kube-proxy-for-scaled-kubernetes-load-balancing ã€‚
 å…§å®¹è„ˆçµ¡
 Preface (å‰è¨€) Introduction (ä»‹ç´¹) Kube-Proxy  What is Kube-proxy (ä»€éº¼æ˜¯ Kube-proxy) Kube-Proxy mode   IPVS  LVS What is IPVS (ä»€éº¼æ˜¯ IPVS) IPVS with Netfilter (IPVS å’Œ Netfilter) IPVS vs iptables (IPVS èˆ‡ iptables çš„æ¯”è¼ƒ)   IPVS-based Kube-proxy  Why using IPVS? (ç‚ºä»€éº¼è¦ç”¨ IPVS) How IPVS-based Kube-proxy work? (IPVS-based Kube-proxy æ˜¯æ€éº¼é‹ä½œçš„) Run Kube-proxy in IPVS mode (ä¾†åŸ·è¡Œ IPVS mode çš„ Kube-proxy) IPVS Service Network Topology Example   Implement IPVS-based K8s service load balancing (å¯¦ç¾ IPVS-based K8s service load balancing) Conclusion (çµè«–)  Preface (å‰è¨€) åœ¨ä¸€èˆ¬ä½¿ç”¨ Kubernetes çš„ kube-proxy æƒ…æ³ä¸‹ï¼Œé€šå¸¸éƒ½ä½¿ç”¨ iptables æ¨¡å¼ã€‚"><meta itemprop="datePublished" content="2018-10-15T12:05:37+08:00" />
<meta itemprop="dateModified" content="2018-10-15T12:05:37+08:00" />
<meta itemprop="wordCount" content="1227">
<meta itemprop="keywords" content="Kubernetes,K8s,container,kube-proxy,IPVS,Cloud-Native," />
</head>
<body>

  <header style="background-image:linear-gradient(
      rgba(0,0,0,0.4),rgba(0,0,0,0.4)
    ),url(&#39;https://bestsamina.github.io/images/default-sidebar.jpg&#39;)">
  <div class="intro">
    <div class="logo-container">
      <a href="/">
        <img src='https://bestsamina.github.io/images/person.jpg' alt="Profile Stacer - ç³»çµ±å„ªåŒ–å™¨" class="rounded-logo">
      </a>
    </div>
    <h3>Hi, I'm Samina ğŸ‘‹</h3>
    <h4>This is my Life & Technological Journey</h4>
    <div class="menu">
      

        <p>
            <a href="/posts/">
                Post
            </a>
        </p>

        <p>
            <a href="/about/">
                About
            </a>
        </p>

        <p>
            <a href="/tags/">
                Tags
            </a>
        </p>

        <p>
            <a href="/categories/">
                Categories
            </a>
        </p>

        <p>
            <a href="/page/awesome-blogs/">
                Awesome-blogs
            </a>
        </p>

      
    </div>
  </div>

  <div class="socials">
      
  
    <a href="https://github.com/sufuf3" class="social-link" target="_blank" rel="noopener" ><div class="icon">
  <svg width="35px" height="35px" viewBox="0 0 115 115" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
  
  <path d="M102.679 0H12.32C5.52 0 0 5.519 0 12.321v90.358C0 109.48 5.519 115 12.321 115h90.358c6.802 0 12.321-5.519 12.321-12.321V12.32C115 5.52 109.481 0 102.679 0zM71.182 98.494c-2.156.385-2.952-.95-2.952-2.053 0-1.386.051-8.471.051-14.195 0-4.005-1.335-6.546-2.9-7.881C74.878 73.313 84.89 72.003 84.89 55.6c0-4.671-1.669-7.007-4.39-10.01.436-1.105 1.9-5.648-.436-11.552-3.568-1.104-11.731 4.595-11.731 4.595-3.389-.95-7.06-1.438-10.679-1.438-3.62 0-7.29.488-10.679 1.438 0 0-8.163-5.699-11.73-4.595-2.337 5.878-.899 10.422-.437 11.551-2.72 3.004-4.004 5.34-4.004 10.011 0 16.326 9.574 17.712 19.072 18.765-1.232 1.104-2.336 3.003-2.72 5.724-2.44 1.104-8.677 3.004-12.4-3.568-2.335-4.056-6.545-4.39-6.545-4.39-4.159-.05-.282 2.619-.282 2.619 2.772 1.283 4.723 6.212 4.723 6.212 2.49 7.624 14.4 5.057 14.4 5.057 0 3.568.052 9.37.052 10.422 0 1.104-.77 2.438-2.952 2.053C27.21 92.821 15.35 76.701 15.35 57.86c0-23.564 18.02-41.456 41.585-41.456s42.663 17.892 42.663 41.456c.026 18.842-11.474 34.988-28.416 40.635zM46 82.81c-.488.103-.95-.102-1.001-.436-.051-.385.282-.719.77-.822.488-.05.95.154 1.001.488.077.334-.257.668-.77.77zm-2.439-.23c0 .333-.385.615-.898.615-.565.052-.95-.23-.95-.616 0-.333.385-.616.899-.616.487-.051.95.231.95.616zm-3.516-.283c-.103.334-.616.488-1.053.334-.488-.103-.821-.488-.719-.822.103-.334.617-.488 1.053-.385.513.154.847.54.719.873zm-3.158-1.386c-.23.282-.718.23-1.104-.154-.385-.334-.487-.822-.23-1.053.23-.282.718-.23 1.103.154.334.334.462.847.231 1.053zm-2.336-2.336c-.23.154-.667 0-.95-.385-.282-.385-.282-.822 0-1.001.283-.231.72-.052.95.333.283.385.283.847 0 1.053zm-1.668-2.49c-.231.23-.616.103-.899-.154-.282-.334-.333-.719-.102-.899.23-.23.616-.102.898.154.282.334.334.72.103.899zm-1.72-1.9c-.103.231-.436.283-.719.103-.334-.154-.488-.436-.385-.667.103-.154.385-.231.719-.103.334.18.488.462.385.667z"/>
  
  </svg>
</div>
</a>
  

  
    <a href="https://gitlab.com/sufuf3" class="social-link" target="_blank" rel="noopener" ><div class="icon">
  <svg width="35px" height="35px" viewBox="0 0 115 115" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
  
  <path d="M23.76 5.544c-.693-1.991-3.512-1.991-4.228 0L6.892 44.653h29.532c-.022 0-12.663-39.11-12.663-39.11zM.426 64.34c-.582 1.79.067 3.782 1.589 4.923l55.464 41.167-50.61-65.778L.426 64.34zm35.977-19.688L57.5 110.43l21.098-65.778H36.402zm78.173 19.688l-6.444-19.688L57.5 110.43l55.464-41.167a4.475 4.475 0 0 0 1.61-4.923zM95.468 5.544c-.694-1.991-3.513-1.991-4.229 0L78.576 44.653h29.533L95.468 5.543z" />
  
  </svg>
</div>
</a>
  

  
    <a href="https://medium.com/@sufuf3149" class="social-link" target="_blank" rel="noopener" ><div class="icon">
  <svg width="35px" height="35px" viewBox="0 0 115 115" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
  
  <path d="M0 0v115h115V0H0zm95.542 27.235l-6.16 5.905a1.81 1.81 0 0 0-.693 1.72v43.458c-.103.667.154 1.335.693 1.72l6.032 5.904v1.31h-30.29v-1.259l6.238-6.058c.616-.616.616-.795.616-1.72V43.074L54.625 87.123h-2.336l-20.202-44.05v29.52c-.18 1.233.257 2.49 1.13 3.39l8.111 9.83v1.31H18.277v-1.31l8.111-9.83a3.93 3.93 0 0 0 1.053-3.39v-34.14a2.93 2.93 0 0 0-.976-2.516l-7.213-8.702v-1.309h22.41l17.301 37.991 15.222-37.965h21.357v1.283z"/>
  
  </svg>
</div>
</a>
  

  
    <a href="https://twitter.com/sufuf3149" class="social-link" target="_blank" rel="noopener" ><div class="icon">
  <svg width="35px" height="35px" viewBox="0 0 115 115" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
  
  <path d="M102.679 0H12.32C5.52 0 0 5.519 0 12.321v90.358C0 109.48 5.519 115 12.321 115h90.358c6.802 0 12.321-5.519 12.321-12.321V12.32C115 5.52 109.481 0 102.679 0zM90.126 40.763c.051.72.051 1.464.051 2.182 0 22.256-16.942 47.9-47.9 47.9-9.548 0-18.404-2.772-25.848-7.547 1.36.154 2.67.205 4.055.205 7.881 0 15.12-2.67 20.895-7.187-7.392-.154-13.604-5.006-15.735-11.68 2.593.385 4.929.385 7.598-.308a16.837 16.837 0 0 1-13.476-16.531v-.205a16.824 16.824 0 0 0 7.598 2.13 16.8 16.8 0 0 1-7.496-14.016c0-3.131.822-6.006 2.285-8.496a47.803 47.803 0 0 0 34.705 17.61c-2.387-11.424 6.161-20.69 16.429-20.69 4.851 0 9.215 2.027 12.296 5.313a32.99 32.99 0 0 0 10.678-4.056 16.792 16.792 0 0 1-7.393 9.267c3.389-.36 6.674-1.31 9.703-2.618a35.437 35.437 0 0 1-8.445 8.727z"/>
  
  </svg>
</div>
</a>
  

  </div>
</header>

<div class="mobile-header">
  <p> Samina Website </p>
  <div class="hamburger">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
  </div>
</div>

<div class="overlay-menu">
  <header>
    <div class="intro">
      <div class="logo-container">
        <a href="/">
          <img src='https://bestsamina.github.io/images/person.jpg' alt="Profile Stacer - ç³»çµ±å„ªåŒ–å™¨" class="rounded-logo">
        </a>
      </div>
      <h3>Hi, I'm Samina ğŸ‘‹</h3>
      <h4>This is my Life & Technological Journey</h4>
      <div class="menu">
        

        <p>
            <a href="/posts/">
                Post
            </a>
        </p>

        <p>
            <a href="/about/">
                About
            </a>
        </p>

        <p>
            <a href="/tags/">
                Tags
            </a>
        </p>

        <p>
            <a href="/categories/">
                Categories
            </a>
        </p>

        <p>
            <a href="/page/awesome-blogs/">
                Awesome-blogs
            </a>
        </p>

        
      </div>
    </div>

    <div class="socials">
        
  
    <a href="https://github.com/sufuf3" class="social-link" target="_blank" rel="noopener" ><div class="icon">
  <svg width="35px" height="35px" viewBox="0 0 115 115" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
  
  <path d="M102.679 0H12.32C5.52 0 0 5.519 0 12.321v90.358C0 109.48 5.519 115 12.321 115h90.358c6.802 0 12.321-5.519 12.321-12.321V12.32C115 5.52 109.481 0 102.679 0zM71.182 98.494c-2.156.385-2.952-.95-2.952-2.053 0-1.386.051-8.471.051-14.195 0-4.005-1.335-6.546-2.9-7.881C74.878 73.313 84.89 72.003 84.89 55.6c0-4.671-1.669-7.007-4.39-10.01.436-1.105 1.9-5.648-.436-11.552-3.568-1.104-11.731 4.595-11.731 4.595-3.389-.95-7.06-1.438-10.679-1.438-3.62 0-7.29.488-10.679 1.438 0 0-8.163-5.699-11.73-4.595-2.337 5.878-.899 10.422-.437 11.551-2.72 3.004-4.004 5.34-4.004 10.011 0 16.326 9.574 17.712 19.072 18.765-1.232 1.104-2.336 3.003-2.72 5.724-2.44 1.104-8.677 3.004-12.4-3.568-2.335-4.056-6.545-4.39-6.545-4.39-4.159-.05-.282 2.619-.282 2.619 2.772 1.283 4.723 6.212 4.723 6.212 2.49 7.624 14.4 5.057 14.4 5.057 0 3.568.052 9.37.052 10.422 0 1.104-.77 2.438-2.952 2.053C27.21 92.821 15.35 76.701 15.35 57.86c0-23.564 18.02-41.456 41.585-41.456s42.663 17.892 42.663 41.456c.026 18.842-11.474 34.988-28.416 40.635zM46 82.81c-.488.103-.95-.102-1.001-.436-.051-.385.282-.719.77-.822.488-.05.95.154 1.001.488.077.334-.257.668-.77.77zm-2.439-.23c0 .333-.385.615-.898.615-.565.052-.95-.23-.95-.616 0-.333.385-.616.899-.616.487-.051.95.231.95.616zm-3.516-.283c-.103.334-.616.488-1.053.334-.488-.103-.821-.488-.719-.822.103-.334.617-.488 1.053-.385.513.154.847.54.719.873zm-3.158-1.386c-.23.282-.718.23-1.104-.154-.385-.334-.487-.822-.23-1.053.23-.282.718-.23 1.103.154.334.334.462.847.231 1.053zm-2.336-2.336c-.23.154-.667 0-.95-.385-.282-.385-.282-.822 0-1.001.283-.231.72-.052.95.333.283.385.283.847 0 1.053zm-1.668-2.49c-.231.23-.616.103-.899-.154-.282-.334-.333-.719-.102-.899.23-.23.616-.102.898.154.282.334.334.72.103.899zm-1.72-1.9c-.103.231-.436.283-.719.103-.334-.154-.488-.436-.385-.667.103-.154.385-.231.719-.103.334.18.488.462.385.667z"/>
  
  </svg>
</div>
</a>
  

  
    <a href="https://gitlab.com/sufuf3" class="social-link" target="_blank" rel="noopener" ><div class="icon">
  <svg width="35px" height="35px" viewBox="0 0 115 115" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
  
  <path d="M23.76 5.544c-.693-1.991-3.512-1.991-4.228 0L6.892 44.653h29.532c-.022 0-12.663-39.11-12.663-39.11zM.426 64.34c-.582 1.79.067 3.782 1.589 4.923l55.464 41.167-50.61-65.778L.426 64.34zm35.977-19.688L57.5 110.43l21.098-65.778H36.402zm78.173 19.688l-6.444-19.688L57.5 110.43l55.464-41.167a4.475 4.475 0 0 0 1.61-4.923zM95.468 5.544c-.694-1.991-3.513-1.991-4.229 0L78.576 44.653h29.533L95.468 5.543z" />
  
  </svg>
</div>
</a>
  

  
    <a href="https://medium.com/@sufuf3149" class="social-link" target="_blank" rel="noopener" ><div class="icon">
  <svg width="35px" height="35px" viewBox="0 0 115 115" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
  
  <path d="M0 0v115h115V0H0zm95.542 27.235l-6.16 5.905a1.81 1.81 0 0 0-.693 1.72v43.458c-.103.667.154 1.335.693 1.72l6.032 5.904v1.31h-30.29v-1.259l6.238-6.058c.616-.616.616-.795.616-1.72V43.074L54.625 87.123h-2.336l-20.202-44.05v29.52c-.18 1.233.257 2.49 1.13 3.39l8.111 9.83v1.31H18.277v-1.31l8.111-9.83a3.93 3.93 0 0 0 1.053-3.39v-34.14a2.93 2.93 0 0 0-.976-2.516l-7.213-8.702v-1.309h22.41l17.301 37.991 15.222-37.965h21.357v1.283z"/>
  
  </svg>
</div>
</a>
  

  
    <a href="https://twitter.com/sufuf3149" class="social-link" target="_blank" rel="noopener" ><div class="icon">
  <svg width="35px" height="35px" viewBox="0 0 115 115" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
  
  <path d="M102.679 0H12.32C5.52 0 0 5.519 0 12.321v90.358C0 109.48 5.519 115 12.321 115h90.358c6.802 0 12.321-5.519 12.321-12.321V12.32C115 5.52 109.481 0 102.679 0zM90.126 40.763c.051.72.051 1.464.051 2.182 0 22.256-16.942 47.9-47.9 47.9-9.548 0-18.404-2.772-25.848-7.547 1.36.154 2.67.205 4.055.205 7.881 0 15.12-2.67 20.895-7.187-7.392-.154-13.604-5.006-15.735-11.68 2.593.385 4.929.385 7.598-.308a16.837 16.837 0 0 1-13.476-16.531v-.205a16.824 16.824 0 0 0 7.598 2.13 16.8 16.8 0 0 1-7.496-14.016c0-3.131.822-6.006 2.285-8.496a47.803 47.803 0 0 0 34.705 17.61c-2.387-11.424 6.161-20.69 16.429-20.69 4.851 0 9.215 2.027 12.296 5.313a32.99 32.99 0 0 0 10.678-4.056 16.792 16.792 0 0 1-7.393 9.267c3.389-.36 6.674-1.31 9.703-2.618a35.437 35.437 0 0 1-8.445 8.727z"/>
  
  </svg>
</div>
</a>
  

    </div>
  </header>
</div>

  <div class="content-wrapper">
    
      <div class="breadcrumb">
  





<span >
  <a href="https://bestsamina.github.io/">Home</a>
   / 
</span>


<span >
  <a href="https://bestsamina.github.io/posts/">Posts</a>
   / 
</span>


<span  class="active">
  <a href="https://bestsamina.github.io/posts/2018-10-19-ipvs-based-kube-proxy-4-scaled-k8s-lb/">IPVS-based Kube-proxy for Scaled Kubernetes Load Balancing</a>
  
</span>

</div>

    
    <main id="content" class="posts">

<h1>IPVS-based Kube-proxy for Scaled Kubernetes Load Balancing</h1>


<span>
    Monday, October 15, 2018
</span>
<br><br>

<ul id="tags">
  
    <li> <a href="https://bestsamina.github.io/tagskubernetes">Kubernetes</a> </li>
  
    <li> <a href="https://bestsamina.github.io/tagsk8s">K8s</a> </li>
  
    <li> <a href="https://bestsamina.github.io/tagscontainer">container</a> </li>
  
    <li> <a href="https://bestsamina.github.io/tagskube-proxy">kube-proxy</a> </li>
  
    <li> <a href="https://bestsamina.github.io/tagsipvs">IPVS</a> </li>
  
    <li> <a href="https://bestsamina.github.io/tagscloud-native">Cloud-Native</a> </li>
  
</ul>


<span>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#preface-å‰è¨€">Preface (å‰è¨€)</a></li>
    <li><a href="#introduction-ä»‹ç´¹">Introduction (ä»‹ç´¹)</a></li>
    <li><a href="#kube-proxy">Kube-Proxy</a>
      <ul>
        <li><a href="#what-is-kube-proxy-ä»€éº¼æ˜¯-kube-proxy">What is Kube-proxy (ä»€éº¼æ˜¯ Kube-proxy)</a></li>
        <li><a href="#kube-proxy-mode">Kube-Proxy mode</a></li>
      </ul>
    </li>
    <li><a href="#ipvs">IPVS</a>
      <ul>
        <li><a href="#lvs">LVS</a></li>
        <li><a href="#what-is-ipvs-ä»€éº¼æ˜¯-ipvs">What is IPVS (ä»€éº¼æ˜¯ IPVS)</a></li>
        <li><a href="#ipvs-with-netfilter-ipvs-å’Œ-netfilter">IPVS with Netfilter (IPVS å’Œ Netfilter)</a></li>
        <li><a href="#ipvs-vs-iptables-ipvs-èˆ‡-iptables-çš„æ¯”è¼ƒ">IPVS vs iptables (IPVS èˆ‡ iptables çš„æ¯”è¼ƒ)</a></li>
      </ul>
    </li>
    <li><a href="#ipvs-based-kube-proxy">IPVS-based Kube-proxy</a>
      <ul>
        <li><a href="#why-using-ipvs-ç‚ºä»€éº¼è¦ç”¨-ipvs">Why using IPVS? (ç‚ºä»€éº¼è¦ç”¨ IPVS)</a></li>
        <li><a href="#how-ipvs-based-kube-proxy-work-ipvs-based-kube-proxy-æ˜¯æ€éº¼é‹ä½œçš„">How IPVS-based Kube-proxy work? (IPVS-based Kube-proxy æ˜¯æ€éº¼é‹ä½œçš„)</a></li>
        <li><a href="#run-kube-proxy-in-ipvs-mode-ä¾†åŸ·è¡Œ-ipvs-mode-çš„-kube-proxy">Run Kube-proxy in IPVS mode (ä¾†åŸ·è¡Œ IPVS mode çš„ Kube-proxy)</a></li>
        <li><a href="#ipvs-service-network-topology">IPVS Service Network Topology</a></li>
        <li><a href="#example">Example</a></li>
      </ul>
    </li>
    <li><a href="#implement-ipvs-based-k8s-service-load-balancing-å¯¦ç¾-ipvs-based-k8s-service-load-balancing">Implement IPVS-based K8s service load balancing (å¯¦ç¾ IPVS-based K8s service load balancing)</a></li>
    <li><a href="#conclusion-çµè«–">Conclusion (çµè«–)</a></li>
    <li><a href="#å…¶ä»–">å…¶ä»–</a></li>
    <li><a href="#åƒè€ƒ">åƒè€ƒ</a></li>
  </ul>
</nav>
</span>

<blockquote>
<p>é€™ç¯‡ç‚º <a href="https://www.accupass.com/event/1810120759471826477649">10æœˆ19æ—¥ talk</a> çš„æ–‡å­—ç‰ˆï¼Œ slides æ˜¯ <a href="https://speakerdeck.com/sufuf3/ipvs-based-kube-proxy-for-scaled-kubernetes-load-balancing">https://speakerdeck.com/sufuf3/ipvs-based-kube-proxy-for-scaled-kubernetes-load-balancing</a> ã€‚</p>
</blockquote>
<p>å…§å®¹è„ˆçµ¡</p>
<ul>
<li>Preface (å‰è¨€)</li>
<li>Introduction (ä»‹ç´¹)</li>
<li>Kube-Proxy
<ul>
<li>What is Kube-proxy (ä»€éº¼æ˜¯ Kube-proxy)</li>
<li>Kube-Proxy mode</li>
</ul>
</li>
<li>IPVS
<ul>
<li>LVS</li>
<li>What is IPVS (ä»€éº¼æ˜¯ IPVS)</li>
<li>IPVS with Netfilter (IPVS å’Œ Netfilter)</li>
<li>IPVS vs iptables (IPVS èˆ‡ iptables çš„æ¯”è¼ƒ)</li>
</ul>
</li>
<li>IPVS-based Kube-proxy
<ul>
<li>Why using IPVS? (ç‚ºä»€éº¼è¦ç”¨ IPVS)</li>
<li>How IPVS-based Kube-proxy work? (IPVS-based Kube-proxy æ˜¯æ€éº¼é‹ä½œçš„)</li>
<li>Run Kube-proxy in IPVS mode (ä¾†åŸ·è¡Œ IPVS mode çš„ Kube-proxy)</li>
<li>IPVS Service Network Topology</li>
<li>Example</li>
</ul>
</li>
<li>Implement IPVS-based K8s service load balancing (å¯¦ç¾ IPVS-based K8s service load balancing)</li>
<li>Conclusion (çµè«–)</li>
</ul>
<h2 id="preface-å‰è¨€">Preface (å‰è¨€)</h2>
<p>åœ¨ä¸€èˆ¬ä½¿ç”¨ Kubernetes çš„ kube-proxy æƒ…æ³ä¸‹ï¼Œé€šå¸¸éƒ½ä½¿ç”¨ iptables æ¨¡å¼ã€‚<br>
ç„¶è€Œåœ¨ 2015/11/19 ï¼ŒK8s åœ˜éšŠçš„æˆå“¡ - <a href="https://github.com/thockin">Tim Hockin</a> æå‡ºäº†ä¸€å€‹ Issue - <a href="https://github.com/kubernetes/kubernetes/issues/17470">&ldquo;Try kube-proxy via ipvs instead of iptables or userspace&rdquo;</a> è€Œåº•ä¸‹ä¹Ÿå‡ºç¾äº†ä¸€äº›è¨è«–ã€‚<br>
æœ‰è¶£çš„æ˜¯ï¼Œå¤§å®¶éƒ½èªª IPVS æ¯” iptables å¥½ã€‚<br>
åœ¨å»å¹´ï¼Œè¯ç‚ºæå‡ºäº†ä½¿ç”¨ IPVS å„ªåŒ– service æ€§èƒ½çš„å ´æ™¯ã€‚(<a href="https://github.com/kubernetes/kubernetes/issues/44063">ref1</a>, <a href="https://zhuanlan.zhihu.com/p/37230013">ref2</a>)<br>
ä»Šå¹´ 2018/06/28 <a href="https://github.com/kubernetes/kubernetes/releases/tag/v1.11.0">K8s v1.11</a> ä¹Ÿæ–°å¢äº† IPVS-based kube-proxy çš„åŠŸèƒ½ã€‚(<a href="https://kubernetes.io/blog/2018/06/27/kubernetes-1.11-release-announcement/">ref1</a>, <a href="https://kubernetes.io/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/">ref2</a>)</p>
<p>ä¹Ÿå› æ­¤ï¼Œæœ¬ç¯‡å°±ä¾†æ¢è¨</p>
<ol>
<li>åˆ°åº• IPVS æ˜¯ä»€éº¼</li>
<li>ç‚ºä»€éº¼ kube-proxy ä½¿ç”¨ IPVS mode æœƒæ¯” iptables mode å¥½</li>
<li>kube-proxy çš„ IPVS æ˜¯æ€éº¼å¯¦ç¾çš„</li>
<li>è¦æ€éº¼ä½¿ç”¨ kube-proxy çš„ IPVS mode ä¾†å¯¦ç¾ Kubernetes service çš„ load balance</li>
</ol>
<h2 id="introduction-ä»‹ç´¹">Introduction (ä»‹ç´¹)</h2>
<p>åœ¨æœ¬ç¯‡ï¼Œå°‡ä»‹ç´¹ IPVS èˆ‡ Kube-proxy çš„ IPVS mode ã€‚ä¸¦ä¸”èªªæ˜ IPVS èˆ‡ iptable çš„å·®ç•°ã€‚ä»¥åŠå¯¦ä½œã€‚</p>
<h2 id="kube-proxy">Kube-Proxy</h2>
<h3 id="what-is-kube-proxy-ä»€éº¼æ˜¯-kube-proxy">What is Kube-proxy (ä»€éº¼æ˜¯ Kube-proxy)</h3>
<p><a href="https://kubernetes.io/docs/concepts/architecture/cloud-controller/"><img src="https://i.imgur.com/apjNBut.png" alt=""></a><br>
åœ¨å®˜ç¶²ä¸­çš„é€™å¼µåœ–ï¼Œæœƒçœ‹åˆ°æ¯ä¸€å° Minion node éƒ½æœ‰ kube-proxy é€™å€‹å…ƒä»¶ã€‚<br>
æ‰€ä»¥ kube-proxy æ˜¯ä»€éº¼æ¨£çš„åŠŸèƒ½è¦é•·åœ¨æ¯ä¸€å° node ä¸Šå‘¢ï¼Ÿ<br>
è¦è«‡è«– kube-proxy å°±ä¸å¾—ä¸å’Œ service ä¸€èµ·è«‡è«–äº†ã€‚</p>
<p>æˆ‘å€‘çŸ¥é“ç•¶ backend çš„ pod éœ€è¦æä¾› port çµ¦å¤–éƒ¨ access æ™‚å€™ï¼Œå°±éœ€è¦ service ã€‚<br>
Service æ˜¯æŠ½è±¡çš„ä¸€å±¤ï¼Œä¸»è¦å®šç¾©ä¸€çµ„ pod å’Œç¶²è·¯çš„è¦å‰‡è®“å¤–éƒ¨å¯ä»¥ access ã€‚<br>
é‚£ service å®šç¾©å¥½é€™äº›ç¶²è·¯çš„è¨ªå•è¦å‰‡ï¼Œé‚£ç¸½è¦æœ‰äººä¾†å¯¦ç¾é€™äº›è¦å‰‡ï¼Œé€™å°±è¦æåˆ° kube-proxy äº†ã€‚<br>
å› ç‚º kube-proxy æ˜¯å¯¦ç¾ service é€™åŠŸèƒ½çš„é—œéµã€‚</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/cc38b0f3c0fd94e66495e3a4198f2096cdecd3d5/ace10/docs/tutorials/kubernetes-basics/public/images/module_04_services.svg" alt=""></p>
<p>kube-proxy ä»‹ç´¹ï¼š</p>
<ul>
<li>ç®¡ç† host ä¸Šçš„ç¶²è·¯è¦å‰‡ä¾†ç¢ºä¿ k8s çš„ service å®šç¾©çš„è¦å‰‡</li>
<li>åŸ·è¡Œé€£ç·šçš„ forwarding</li>
<li>åœ¨æ¯ä¸€å° node ä¸Šéƒ½æœ‰ kube-proxy</li>
<li>proxies UDP, TCP and SCTP</li>
<li>æä¾› load balancing</li>
<li>å°ˆé–€å¯¦ç¾ service</li>
</ul>
<p>é‚£è¦æ€éº¼é”åˆ°ç®¡ç† host ä¸Šçš„ç¶²è·¯è¦å‰‡ï¼Œé€™å°±è¦ä¾†çœ‹ä»–æœ‰æä¾›å“ªäº› modeã€‚</p>
<h3 id="kube-proxy-mode">Kube-Proxy mode</h3>
<p>æœ‰<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/">ä¸‰ç¨®</a>ï¼š</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/proxy/userspace">userspace (older)</a>:
å¾åœ–ç‰‡ä¸­æˆ‘å€‘å¯ä»¥çœ‹åˆ°ï¼Œç•¶å¤–éƒ¨ Client è«‹æ±‚ service IP å¾Œï¼Œæœƒæ¯”å° iptales çš„ rule ç„¶å¾Œå°‡å°åŒ…è½‰é€åˆ° kube-Proxy é€™å€‹ app pod ï¼Œå†ç”± kube-proxy è™•ç†å°åŒ…çš„è½‰é€åˆ°å¾Œç«¯çš„ podã€‚<br>
<img src="https://d33wubrfki0l68.cloudfront.net/b8e1022c2dd815d8dd36b1bc4f0cc3ad870a924f/1dd12/images/docs/services-userspace-overview.svg" alt=""></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/proxy/iptables">iptables (faster)</a>:
iptables å°±æ¯” userspace å¥½ä¸€äº›ï¼Œå› ç‚º client è«‹æ±‚ service IP å¾Œï¼Œå°±äº¤çµ¦ iptables è™•ç†å°åŒ…çš„è½‰é€ã€‚è€Œä¸‹ iptables rule å°±æ˜¯ç•¶ api-server æ‹¿åˆ° service çš„ yaml æª”å¾Œï¼Œapi-server æœƒçµ¦ kube-proxy ä¾†è™•ç†ï¼Œè€Œ kube-proxy å°±ä¾†ä¸‹ iptables çš„ rule å›‰ï¼<br>
<img src="https://d33wubrfki0l68.cloudfront.net/837afa5715eb31fb9ca6516ec6863e810f437264/42951/images/docs/services-iptables-overview.svg" alt=""></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/proxy/ipvs">ipvs (experimental)</a>:
å’Œ iptables mode æ–¹å¼é›·åŒï¼Œä½†æ˜¯æ˜¯ä½¿ç”¨ kernel space çš„ IPVS æ–¹æ³•è™•ç†è¦è½‰é€çš„å°åŒ…ï¼Œä¸å—é™æ–¼ iptables çš„è¦å‰‡ã€‚<br>
<img src="https://d33wubrfki0l68.cloudfront.net/3ece58e40119539d5e999fe137e79b5015c24275/77563/images/docs/services-ipvs-overview.svg" alt=""></p>
</li>
</ul>
<h2 id="ipvs">IPVS</h2>
<p>åœ¨è¬› IPVS ä¹‹å‰ï¼Œæˆ‘å€‘ä¸å¾—ä¸æåˆ° LVSã€‚</p>
<h3 id="lvs">LVS</h3>
<p>LVS å…¨åæ˜¯ <code>Linux Virtual Server</code>ã€‚å®ƒæ˜¯åœ¨ cloud ä¸Šæˆ–æ˜¯çœŸå¯¦ server ä¸Šçš„é«˜å¯æ“´å±•èˆ‡é«˜å¯ç”¨çš„ serverã€‚é€šå¸¸æœƒä¼´éš¨ load balancer ä¸€èµ·åœ¨ Linux OS ä¸Šé‹è¡Œã€‚<br>
æœ€æœ‰åçš„å°±æ˜¯é€™å¼µåœ–ç‰‡æ‹‰ï¼<br>
<img src="https://i.imgur.com/9vLMHjv.png" alt=""><br>
å°å¤–é¢çš„ user ä¾†èªªï¼Œä»– access çš„æ˜¯å€‹æ©Ÿå™¨ï¼Œä½†å°é›†ç¾¤ä¾†èªª user access åˆ°çš„å…¶å¯¦æ˜¯è™›æ“¬çš„ serverï¼Œè€Œè™›æ“¬çš„ server æ˜¯ç”±ä¸€ç¾¤åœ¨åŒå€‹ LAN æˆ–æ˜¯ WAN ä¸­çš„çœŸå¯¦çš„ server å’Œ Load Balancer æ‰€çµ„æˆçš„ã€‚</p>
<p>é‚£ Virtual Server ç¸½æ˜¯è¦æœ‰å€‹ IP çµ¦å¤–é¢çš„ user çŸ¥é“å§ï¼æ‰€ä»¥<a href="http://www.linuxvirtualserver.org/HighAvailability.html">å®˜æ–¹ç¶²ç«™</a>ä¹Ÿæä¾›ä¸‹é¢é€™å¼µåœ–ï¼Œç”±åœ–æ‰€çŸ¥ï¼Œå°±æ˜¯æœƒæœ‰å€‹ Virtual IP æ‹‰ï¼<br>
<img src="https://i.imgur.com/EU0gAUv.png" alt=""></p>
<p>é‚£ LVS å’Œ IPVS çš„é—œä¿‚åˆæ˜¯ä»€éº¼å‘¢ï¼Ÿ<br>
é€™è¦ä¾†çœ‹çœ‹ <a href="http://www.linuxvirtualserver.org/about.html">LVS çš„æ¡†æ¶</a>äº†ã€‚<br>
<img src="https://i.imgur.com/lE6iI9F.png" alt=""><br>
ç”±åœ–ä¸­æ‰€çŸ¥ï¼ŒIPVS æ˜¯åœ¨ LVS æ¡†æ¶ä¸­æœ€åº•å±¤çš„ä½ç½®ã€‚ä¹Ÿå°±æ˜¯èªª LVS æ˜¯ base on IPVS ä¾†å¯¦ç¾çš„æ‹‰ï¼é‚£æˆ‘å€‘å°±è¦ä¾†çœ‹çœ‹ IPVS äº†ã€‚</p>
<h3 id="what-is-ipvs-ä»€éº¼æ˜¯-ipvs">What is IPVS (ä»€éº¼æ˜¯ IPVS)</h3>
<ul>
<li>IPVS å…¨å IP Virtual Server</li>
<li>å¯¦ç¾ L4 çš„ load balancing</li>
<li>ä¹Ÿç¨± Layer-4 switching</li>
<li>ä¸»è¦åœ¨ cluster å‰çš„å¯¦é«”ä¸»æ©Ÿä¸Šé‹è¡Œ</li>
<li>ç›´æ¥è«‹æ±‚ base on service çš„ TCP / UDP åˆ°çœŸå¯¦çš„ server</li>
<li>ä½¿çœŸå¯¦ server çš„ service é¡¯ç¤ºç‚ºæœ‰ä¸€å€‹ IP çš„è™›æ“¬ service</li>
<li>å¯¦ç¾ç‚º Netfilter æ¡†æ¶ä¸Šçš„ module</li>
<li>Based on kernel ä¸­çš„ hash tables</li>
<li>Kernel source code: net/netfilter/ipvs</li>
<li>ipvsadm æ˜¯ç®¡ç† IPVS çš„å·¥å…·</li>
</ul>
<h3 id="ipvs-with-netfilter-ipvs-å’Œ-netfilter">IPVS with Netfilter (IPVS å’Œ Netfilter)</h3>
<p>é‚£æˆ‘å€‘çŸ¥é“ IPVS æ˜¯ä½¿ç”¨ Netfilter çš„ moduleï¼Œé‚£å°±ä¾†çœ‹çœ‹ IPVS å’Œ Netfilter ä¹‹é–“çš„é—œä¿‚å§ï¼</p>
<blockquote>
<p>Ref: <a href="http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.filter_rules.html">http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.filter_rules.html</a>, <a href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture">https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture</a>, <a href="http://www.178linux.com/13570">http://www.178linux.com/13570</a></p>
</blockquote>
<p><img src="https://i.imgur.com/i60QKw4.png" alt=""></p>
<ol>
<li>ç•¶ client çš„è«‹æ±‚å¾å¤–éƒ¨é€²åˆ° Load balencer çš„ kernel space æ™‚ï¼Œæœƒå…ˆåˆ° PREROUTING çš„ chainã€‚</li>
<li>æ¥è‘— Route æœƒä¾æ“šé€²ä¾†çš„å°åŒ… destination address åˆ¤æ–·æ˜¯ä¸æ˜¯æœ¬æ©Ÿçš„(é€šå¸¸æ˜¯ VIP å­˜åœ¨æ–¼æœ¬æ©Ÿçš„ network interface ä¸Š)ã€‚å¦‚æœæ˜¯æœ¬æ©Ÿçš„å°åŒ…ï¼Œå°±å°‡å°åŒ…å¾€ INPUT chain é€ã€‚</li>
<li>è€Œ ip_vs_in æ›å‹¾åˆ° LOCAL_INï¼Œæ‰€ä»¥æœ€çµ‚æœƒçµ¦ IPVS ä¾†æª¢æŸ¥é€™å€‹é€²ä¾†çš„å°åŒ…ã€‚
(module ä»¥å„ªå…ˆæ¬Šä¾†æ±ºå®šï¼Œå„ªå…ˆæ¬Šä½çš„å…ˆçœ‹å°åŒ…ï¼ŒIPVS çš„å„ªå…ˆæ¬Šé«˜æ–¼ iptables æ‰€ä»¥æœƒå…ˆçµ¦ iptable çœ‹ï¼Œä¹‹å¾Œçµ¦ IPVS çœ‹ã€‚)</li>
<li>åœ¨ LOCAL_IN Hook å¦‚æœ ip_vs_in ç™¼ç¾é€™å€‹å°åŒ…éƒ½æœ‰åœ¨ IPVS è¦å‰‡ä¸­ï¼Œå°±æœƒ trigger INPUT chain ä¹‹å¾Œåˆ° POSTROUTING chain å°±çµæŸã€‚
ç”±ä¸Šé¢å¯çŸ¥ï¼Œä½¿ç”¨ IPVS ä¸æœƒæ¥è§¸åˆ° iptables çš„ ruleã€‚</li>
</ol>
<h3 id="ipvs-vs-iptables-ipvs-èˆ‡-iptables-çš„æ¯”è¼ƒ">IPVS vs iptables (IPVS èˆ‡ iptables çš„æ¯”è¼ƒ)</h3>
<p>å¤§è‡´äº†è§£ IPVS ï¼Œé‚£ IPVS å’Œ iptables æœ‰ä»€éº¼å·®åˆ¥å‘¢ï¼Ÿ<br>
ä»–å€‘å…¶å¯¦éƒ½æ˜¯ä½¿ç”¨ Netfilter ï¼Œä¾†è®“å°åŒ…é”åˆ°è½‰é€çš„æ©Ÿåˆ¶ã€‚<br>
ä½†å¯¦ä½œé¢å»æ˜¯ä¸ä¸€æ¨£çš„ã€‚<br>
åœ¨ INPUT chain é€™é‚Šï¼Œä¸è«–æ˜¯ IPVS æˆ–æ˜¯ iptables éƒ½æœƒåˆ° userspace ä¾†é€²è¡Œå°åŒ…è§£æï¼Œä¾†çœ‹çœ‹å°åŒ…è¦å¾€å“ªé‚Šèµ°ã€‚<br>
ç„¶è€Œï¼Œå°±æ˜¯åœ¨åˆ¤æ–·å°åŒ…è¦å¾€å“ªé‚Šèµ°ï¼Œé€™é‚Šçš„æ–¹æ³•å…©è€…ä½¿ç”¨çš„æ–¹å¼æ˜¯ä¸ä¸€æ¨£çš„ã€‚<br>
iptables è¦å‰‡è¨­å®šæ˜¯ï¼šn å¼µ tableï¼Œæ¯å¼µ table å…§æœ‰ m å€‹ chain ï¼Œæ¯å€‹ chain ä¸­æœ‰ ruleã€‚å¦‚åœ–(source: <a href="https://www.thegeekstuff.com/2011/01/iptables-fundamentals/">https://www.thegeekstuff.com/2011/01/iptables-fundamentals/</a>)<br>
<img src="https://static.thegeekstuff.com/wp-content/uploads/2011/01/iptables-table-chain-rule-structure.png" alt=""><br>
é›–ç„¶å°åŒ…ä¸æœƒè·‘éæ‰€æœ‰çš„ Table å’Œ chainã€‚<br>
ä½† rules é€šå¸¸æœƒæ˜¯å¾ˆå¤šçš„ã€‚é›–ç„¶å°åŒ…åªè¦è¢«æ‹†è§£ä¸€æ¬¡ï¼Œä½†å°åŒ…åœ¨æ¯”å°æ¯å€‹ rule æ™‚ï¼Œéƒ½è¦å†çœ‹è¦ç”¨é€²ä¾†çš„é€™å€‹å°åŒ…ç”¨ä»€éº¼æ¬„ä½ä¾†å’Œç›®å‰è¼ªåˆ°çš„ rule é€²è¡Œæ¯”å°ã€‚<br>
é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼æˆ‘å€‘åœ¨ä¸‹ rule çš„æ™‚å€™å¾ˆé‡è¦– rule çš„é †åºæ€§ã€‚(æ‰€ä»¥ rule ä¹Ÿæœƒå› äººçš„è¨­å®šå¥½ä¸å¥½ï¼Œæ•ˆèƒ½ä¹Ÿæœƒæœ‰å·®ç•°)<br>
IPVS åœ¨åˆ¤æ–·ä¸Šé¢å°±ç°¡å–®å¾ˆå¤šï¼Œä»–æ˜¯ç”¨ hash table(é›œæ¹Šè¡¨)ï¼Œåœ¨æ™‚é–“è¤‡é›œåº¦ä¸Šï¼Œé€šå¸¸æ˜¯æ˜¯ O(1)ï¼Œå³ä¾¿é‡åˆ°æœ€å·®çš„æƒ…æ³(worst case)ï¼Œä¹Ÿåªæ˜¯ O(n)ã€‚ç†è«–å¯ä»¥åƒè€ƒï¼šhttps://zh.wikipedia.org/wiki/%E5%93%88%E5%B8%8C%E8%A1%A8 (è‡³æ–¼æ€éº¼åšï¼Œå°±è¦ç¿» source code äº†)</p>
<p>å°±ä¸Šé¢çš„å…©ç¨®åˆ†æå°åŒ…åˆ¤æ–·è¦å¾€å“ªèµ°çš„æ–¹æ³•ï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥äº†è§£åˆ°ä»–å€‘åœ¨å°åŒ…è½‰é€ä¸Šçš„æ•ˆç‡æ˜¯æœ‰å·®åˆ¥çš„ã€‚</p>
<p>è€Œè¯ç‚ºåœ¨å»å¹´çš„<a href="https://www.slideshare.net/LCChina/scale-kubernetes-to-support-50000-services">æ¼”è¬›</a>ä¸­ï¼Œä¹Ÿæœ‰æä¾› k8s kube-proxy ä¸­ä½¿ç”¨ iptables å’Œ IPVS mode çš„å·®ç•°ã€‚(From è¯ç‚ºæŠ•å½±ç‰‡)<br>
<img src="https://i.imgur.com/HrW0m0z.png" alt="">
<img src="https://i.imgur.com/uUFNSMa.png" alt=""></p>
<h2 id="ipvs-based-kube-proxy">IPVS-based Kube-proxy</h2>
<h3 id="why-using-ipvs-ç‚ºä»€éº¼è¦ç”¨-ipvs">Why using IPVS? (ç‚ºä»€éº¼è¦ç”¨ IPVS)</h3>
<p>æ‰¿æ¥ä¸Šé¢ï¼Œæˆ‘å€‘å¯ä»¥å¾—å‡ºç‚ºä»€éº¼è¦ä½¿ç”¨ IPVS çš„çµè«–(<a href="https://www.cncf.io/wp-content/uploads/2018/08/CNCF-Webinar_-Kubernetes-1.11-1.pdf">ref</a>)ã€‚</p>
<ol>
<li>æœ‰è¼ƒä½³çš„ performance (Hashing å’Œ Chain çš„æ•ˆç‡)</li>
<li>æœ‰æ¯”è¼ƒå¤šçš„ load balancing æ¼”ç®—æ³•(å¤šé” 8 ç¨®)</li>
<li>æ”¯æ´ server é‹è¡Œç‹€æ³æª¢æŸ¥å’Œé€£æ¥é‡è©¦</li>
<li>æ”¯æ´ sticky session</li>
<li>iptables æ“ä½œåœ¨å¤§è¦æ¨¡é›†ç¾¤ä¸­é¡¯å¾—æ¯”è¼ƒæ…¢</li>
</ol>
<h3 id="how-ipvs-based-kube-proxy-work-ipvs-based-kube-proxy-æ˜¯æ€éº¼é‹ä½œçš„">How IPVS-based Kube-proxy work? (IPVS-based Kube-proxy æ˜¯æ€éº¼é‹ä½œçš„)</h3>
<p>é‚£æ˜¯æ€éº¼é‹ä½œçš„å‘¢ï¼Ÿæˆ‘å€‘å›é ­å†ä¾†çœ‹é€™å¼µåœ–ç‰‡<br>
<img src="https://d33wubrfki0l68.cloudfront.net/3ece58e40119539d5e999fe137e79b5015c24275/77563/images/docs/services-ipvs-overview.svg" alt=""><br>
æˆ‘å€‘çŸ¥é“åœ¨ Virtual Server é€™é‚Šæ˜¯ä½¿ç”¨ IPVS ï¼Œç„¶å¾Œé€éä»–ç®¡ç†çš„ virtual server table ä¾†è®“ Netfilter æŠŠå°åŒ…é€åˆ°å°çš„åœ°æ–¹ã€‚<br>
é€™å°±æ˜¯ä»–çš„é‹ä½œåŸç†å›‰ï¼</p>
<h3 id="run-kube-proxy-in-ipvs-mode-ä¾†åŸ·è¡Œ-ipvs-mode-çš„-kube-proxy">Run Kube-proxy in IPVS mode (ä¾†åŸ·è¡Œ IPVS mode çš„ Kube-proxy)</h3>
<p>é‚£åœ¨ kube-proxy ä¸­æˆ‘å€‘è¦æ€éº¼ä½¿ç”¨ IPVS mode å‘¢ï¼Ÿ(<a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/proxy/ipvs">ref</a>)</p>
<p><strong>1. é¦–å…ˆæˆ‘å€‘è¦æŠŠ IPVS çš„ kernel module load é€²ä¾†</strong></p>
<pre tabindex="0"><code>modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
cut -f1 -d &#34; &#34;  /proc/modules | grep -e ip_vs -e nf_conntrack_ipv4
</code></pre><p><strong>2. æ¥è‘—åœ¨å•Ÿå‹• kube-proxy æ™‚ï¼Œåƒæ•¸è¨­ç‚º</strong></p>
<pre tabindex="0"><code>--proxy-mode=ipvs
</code></pre><p>(å¦‚æœè¦ä½¿ç”¨å…¶ä»–æ¼”ç®—æ³•ï¼Œé‚£å¯ä»¥è¨­å®š <code>--ipvs-scheduler=rr</code> rr æ”¹ç‚ºå…¶ä»–çš„)</p>
<p><strong>3. å¦‚æœæ˜¯åœ¨ v1.10 ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œ kube-proxy è¦åŠ ä¸‹é¢çš„åƒæ•¸</strong></p>
<pre tabindex="0"><code>--feature-gates=SupportIPVSProxyMode=true
</code></pre><h3 id="ipvs-service-network-topology">IPVS Service Network Topology</h3>
<p>ç•¶å»ºç«‹ ClusterIP type çš„ service æ™‚ï¼ŒIPVS proxier å°‡åŸ·è¡Œä»¥ä¸‹ä¸‰é …æ“ä½œï¼š</p>
<ul>
<li>ç¢ºä¿ç¯€é»ä¸­å­˜åœ¨ dummy æ¥å£ï¼Œé»˜èªç‚º kube-ipvs0</li>
<li>å°‡ service IP ç¶åˆ° dummy æ¥å£</li>
<li>åˆ†åˆ¥ç‚ºæ¯å€‹ service IP å»ºç«‹ IPVS virtual servers</li>
</ul>
<h3 id="example">Example</h3>
<ul>
<li>v1.10.x</li>
</ul>
<pre tabindex="0"><code># kubectl describe svc nginx -n a-ns
Name:              nginx
Namespace:         a-ns
Labels:            run=nginx
Annotations:       &lt;none&gt;
Selector:          run=nginx
Type:              ClusterIP
IP:                10.105.12.124
External IPs:      100.67.151.9
Port:              &lt;unset&gt;  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.241.156:80,10.244.241.158:80
Session Affinity:  None
Events:            &lt;none&gt;

# ip a
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:26:2d:08:03:a4 brd ff:ff:ff:ff:ff:ff
    inet 100.67.151.2/16 brd 100.67.255.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
    inet 100.67.151.9/16 brd 100.67.255.255 scope global secondary eth0:1
       valid_lft forever preferred_lft forever
18: kube-ipvs0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default
    link/ether e6:f5:f6:9f:0b:9a brd ff:ff:ff:ff:ff:ff
    inet 10.96.0.1/32 brd 10.96.0.1 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.96.0.10/32 brd 10.96.0.10 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.105.12.124/32 brd 10.105.12.124 scope global kube-ipvs0
       valid_lft forever preferred_lft forever

# ipvsadm -ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.105.12.124:80 rr
  -&gt; 10.244.241.156:80            Masq    1      0          0
  -&gt; 10.244.241.158:80            Masq    1      0          0
TCP  100.67.151.9:80 rr
  -&gt; 10.244.241.156:80            Masq    1      0          0
  -&gt; 10.244.241.158:80            Masq    1      0          0
</code></pre><ul>
<li>v1.11.x</li>
</ul>
<pre tabindex="0"><code># kubectl describe svc nginx -n a-ns
Name:              nginx
Namespace:         a-ns
Labels:            run=nginx
Annotations:       &lt;none&gt;
Selector:          run=nginx
Type:              ClusterIP
IP:                10.105.12.124
External IPs:      100.67.151.9
Port:              &lt;unset&gt;  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.241.156:80,10.244.241.158:80
Session Affinity:  None
Events:            &lt;none&gt;

# ip a
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:26:2d:08:03:a4 brd ff:ff:ff:ff:ff:ff
    inet 100.67.151.2/16 brd 100.67.255.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
18: kube-ipvs0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default
    link/ether e6:f5:f6:9f:0b:9a brd ff:ff:ff:ff:ff:ff
    inet 10.96.0.1/32 brd 10.96.0.1 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.96.0.10/32 brd 10.96.0.10 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.105.12.124/32 brd 10.105.12.124 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 100.67.151.9/16 brd 100.67.255.255 scope global kube-ipvs0
       valid_lft forever preferred_lft forever

# ipvsadm -ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.105.12.124:80 rr
  -&gt; 10.244.241.156:80            Masq    1      0          0
  -&gt; 10.244.241.158:80            Masq    1      0          0
TCP  100.67.151.9:80 rr
  -&gt; 10.244.241.156:80            Masq    1      0          0
  -&gt; 10.244.241.158:80            Masq    1      0          0
</code></pre><h2 id="implement-ipvs-based-k8s-service-load-balancing-å¯¦ç¾-ipvs-based-k8s-service-load-balancing">Implement IPVS-based K8s service load balancing (å¯¦ç¾ IPVS-based K8s service load balancing)</h2>
<p>è«‹åƒè€ƒé€™ç¯‡<a href="https://bestsamina.github.io/posts/2018-10-15-hands-on-k8s-kube-proxy-w-ipvs-lb/">ç­†è¨˜</a></p>
<h2 id="conclusion-çµè«–">Conclusion (çµè«–)</h2>
<p>å›éé ­ä¾†ï¼Œå†æ¬¡è¤‡ç¿’ä¸€ä¸‹ï¼Œé€™æ¬¡æˆ‘å€‘è¦æ¢è¨çš„æ˜¯ kube-proxy ä¸­çš„ IPVSï¼Œæˆ‘å€‘çŸ¥é“ kube-proxy æ˜¯è¦è™•ç†å°åŒ…é‡å°ä¸åŒçš„ service åšè½‰é€ï¼Œæ˜¯è™•ç†ç¶²è·¯è¦å‰‡çš„ã€‚è¬›ç™½è©±ä¸€é»å°±æ˜¯ï¼Œ pod é–‹å‡ºçµ¦å¤–é¢ access çš„ port æˆ–æ˜¯å°æ‡‰çš„ IP ç­‰ï¼Œ repuest é€²ä¾†ï¼Œ kube-proxy è¦æŠŠé€™å€‹å°åŒ…é€åˆ°å°æ‡‰çš„ podï¼Œè®“ pod è™•ç†ï¼Œåœ¨å›æ‡‰å‡ºå»ã€‚<br>
è€Œå¯ä»¥åšåˆ°å°åŒ…è½‰é€é€™ä»¶äº‹çš„åœ¨ kube-proxy mode ä¸­æœ‰ä¸‰ç¨®æ–¹å¼å¯ä»¥åšåˆ°ã€‚<br>
ç›®å‰æ™®éæ˜¯ iptablesã€‚ä½† IPVS ä¹Ÿå¯ä»¥åšåˆ°ï¼Œè€Œä¸”æ•ˆèƒ½æ›´å¥½ã€‚<br>
ä»¥ä¸‹æ˜¯ IPVS èˆ‡æœ¬æ¬¡ä»‹ç´¹çš„ä¸€äº›é‡é»æ•´ç†</p>
<ul>
<li>IPVS æ˜¯ LVS ä¸­çš„ L4 è² è¼‰å‡è¡¡å™¨</li>
<li>IPVSæä¾›
<ul>
<li>åœ¨ cluster ä¸­æ›´å¥½çš„å¯æ“´å±•æ€§å’Œæ•ˆèƒ½</li>
<li>æœ‰æ¯” iptables æ›´å¤šçš„ load balancing æ¼”ç®—æ³•</li>
<li>server çš„å¥åº·æª¢æŸ¥å’Œé€£æ¥é‡è©¦ç­‰</li>
</ul>
</li>
<li>æˆ‘å€‘å¯ä»¥ä½¿ç”¨ kube-proxy çš„ IPVS æ¨¡å¼</li>
<li>äº†è§£ kube-proxy çš„ IPVS mode çš„é‹ä½œåŸç†</li>
</ul>
<h2 id="å…¶ä»–">å…¶ä»–</h2>
<p>åœ¨æœå°‹ IPVS çš„éç¨‹ä¸­ï¼Œç™¼ç¾äº† <a href="https://lwn.net/Articles/747551/">BPF(Berkeley Packet Filter)</a> ä¸€å€‹å³å°‡è¦å–ä»£ iptables çš„å·¥å…·ã€‚ cilium é€™ç¯‡ blog ä¹ŸæŒ‡å‡ºç‚ºä½•è¦ç”¨ BPFã€‚ è€Œ Facebook ä¹Ÿç™¼ç¾ BPF æ•ˆèƒ½æ¯” IPVS å¥½ï¼Œæ‰€ä»¥æ›æˆ BPFã€‚<br>
æœ‰æ™‚é–“çœ‹ä¾†è¦ç ”ç©¶ä¸€ä¸‹ã€‚</p>
<ul>
<li>Blog <a href="https://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables/">https://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables/</a></li>
<li>FB ç°¡å ±ï¼šhttps://www.netdevconf.org/2.1/slides/apr6/zhou-netdev-xdp-2017.pdf</li>
</ul>
<h2 id="åƒè€ƒ">åƒè€ƒ</h2>
<ul>
<li><a href="https://gigenchang.wordpress.com/2014/04/19/10%E5%88%86%E9%90%98%E5%AD%B8%E6%9C%83iptables/">https://gigenchang.wordpress.com/2014/04/19/10%E5%88%86%E9%90%98%E5%AD%B8%E6%9C%83iptables/</a></li>
</ul>


    </main>
  </div>
  <footer>
    <div class="footer-wrapper">
      <p>Made with â¤ï¸ &mdash; Powered by <a href="https://gohugo.io/" target="_blank" rel="external">Hugo</a> and the <a href="https://github.com/bjacquemet/personal-web" target='_blank' rel="external">Personal Web</a> theme.</p>
      <p>@Samina Fu</p>
    </div>
  </footer>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:500,600|Raleway:400,400i,600" rel="stylesheet">
  
  <script type="text/javascript">
    document.querySelector('.mobile-header').addEventListener('click', function () {
      var om = document.querySelector(".overlay-menu");
      if (document.querySelector('.hamburger').classList.contains("cross")) {
        document.querySelector('.hamburger').classList.remove("cross");
        om.style.display = "none";
        om.style.width = "0%";
        om.style.height = "0%";
      }
      else {
        document.querySelector('.hamburger').classList.add("cross");
        om.style.width = "100%";
        om.style.height = "80vh";
        om.style.display = "block";
      }
    });
  </script>
</body>
</html>
